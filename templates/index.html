<!doctype html>
<html data-theme="light">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>atovio — Label Uploader</title>
  <link rel="icon" href="/static/logo.png">
  <style>
    :root{ --bg:#ffffff; --card:#f7f8fa; --fg:#0b1020; --muted:#475569; --accent:#2563eb; --line:#e5e7eb; --pill:#eef2ff; --highlight:#edf2ff; --ok:#059669; --btnfg:#ffffff; }
    [data-theme="dark"]{ --bg:#0b1020; --card:#121a2b; --fg:#e5e7eb; --muted:#9ca3af; --accent:#60a5fa; --line:#243047; --pill:#0b1222; --highlight:#0b1b34; --ok:#10b981; --btnfg:#08111f; }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--fg);font-family:Inter,system-ui,Segoe UI,Roboto,Arial}
    header{display:flex;align-items:center;gap:12px;padding:14px 18px;border-bottom:1px solid var(--line);background:var(--card)}
    header img{width:40px;height:40px;border-radius:10px}
    header h1{font-size:18px;margin:0}
    header .spacer{flex:1}
    main{max-width:1200px;margin:20px auto;padding:0 16px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px;margin-bottom:16px}
    input[type=file], input[type=text]{padding:10px;border-radius:10px;border:1px solid var(--line);background:var(--pill);color:var(--fg)}
    button{background:var(--accent);color:var(--btnfg);border:0;border-radius:10px;padding:10px 14px;font-weight:600;cursor:pointer}
    button.secondary{background:transparent;color:var(--fg);border:1px solid var(--line)}
    table{width:100%;border-collapse:collapse;font-size:14px}
    th,td{border-bottom:1px solid var(--line);padding:8px 10px;text-align:left;vertical-align:top}
    th{color:var(--muted")}
    tr.active{background:var(--highlight)}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid var(--line);background:var(--pill)}
    .muted{color:var(--muted);font-size:12px}
    .ok{color:var(--ok);font-weight:600}
    #status{min-height:18px}
    .board{display:grid;grid-template-columns:1fr;gap:16px;margin-top:16px}
    @media (min-width: 980px){ .board{grid-template-columns:1fr 1fr} }
    .card h2{margin:0 0 8px 0;font-size:16px;display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    .badge{font-size:12px;border:1px solid var(--line);background:var(--pill);border-radius:999px;padding:2px 8px}
    .toolbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .chip{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--line);background:var(--pill);border-radius:999px;padding:0 8px;font-size:12px;margin:2px 6px 0 0}
    .sq{display:inline-block;width:10px;height:10px;border-radius:2px;border:1px solid var(--line)}
    .sku-line{display:flex;flex-wrap:wrap;align-items:center;gap:8px;margin-top:4px}
    .divider{opacity:.6;margin:0 6px}
    .btn-icon{border:1px solid var(--line);background:var(--pill);border-radius:8px;padding:4px 8px;cursor:pointer}
    .pid-input{
    background:#000; color:#fff; border:1px solid #000;
    border-radius:6px; padding:6px 8px; width:160px;
    }
    .pid-input::placeholder{ color:#aaa; }

  </style>
</head>
<body>
<header>
  <img src="/static/logo.png" alt="logo"/><h1>atovio — Label Uploader & Scanner</h1>
  <div class="spacer"></div>
  <button class="secondary" id="themeBtn" type="button" tabindex="-1" aria-label="Toggle theme">Dark Mode</button>
</header>

<main>
  <div class="card">
    <div class="toolbar">
      <input id="pdf" type="file" accept="application/pdf"/>
      <button id="uploadBtn" type="button">Upload PDF</button>
      <button id="downloadXlsxBtn" class="secondary" type="button">Download XLSX</button>
      <button id="downloadCsvBtn" class="secondary" type="button">Download CSV</button>
      <input id="printerName" type="text" placeholder="Printer name (exact)" style="width:240px"/>
      <button id="savePrinter" class="secondary" type="button">Save Printer</button>
      <span id="status" class="muted"></span>
    </div>
    <div class="row" style="margin-top:10px">
      <div class="muted">Active AWB:</div>
      <div id="activeAwb" class="pill">—</div>
      <input id="scan" type="text" placeholder="Scan here (AT0001-A001 for devices; AT0020 for loose; AWB also accepted)" style="flex:1"
             autocomplete="off" autocapitalize="off" spellcheck="false" autofocus />
    </div>
  </div>

  <div class="card" style="display:none;">
    <div class="row">
      <input id="search" type="text" placeholder="Search customer / SKU / product / AWB" style="flex:1"/>
      <label class="muted"><input type="checkbox" id="onlyAwb"/> Show only Active AWB</label>
      <label class="muted"><input type="checkbox" id="showAssigned"/> Show assigned rows</label>
    </div>
  </div>

  <div class="board">
    <div class="card">
      <h2>Products (with SKU)</h2>
      <!-- totals line under header -->
      <div id="skuLine" class="sku-line"></div>

      <table id="tblWith">
        <thead>
          <tr>
            <th>order_date</th><th>customer_name</th><th>contact_number</th>
            <th>product_name</th><th>sku</th><th>quantity</th><th>awb</th><th>product_id</th><th></th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="card">
      <h2>Extras (no SKU) <span id="countNo" class="badge">0</span></h2>
      <table id="tblNo">
        <thead>
          <tr>
            <th>order_date</th><th>customer_name</th><th>contact_number</th>
            <th>product_name</th><th>quantity</th><th>awb</th><th>product_id</th><th>Confirm</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</main>

<script>
const printerEl = document.getElementById('printerName');
const savePrinterBtn = document.getElementById('savePrinter');
function getPrinter(){ return (localStorage.getItem('printerName') || '').trim(); }
function setPrinter(v){ localStorage.setItem('printerName', (v||'').trim()); }
printerEl.value = getPrinter();
savePrinterBtn.addEventListener('click', ()=> { setPrinter(printerEl.value); alert('Printer saved'); });

(function(){
  
  // ---------- THEME ----------
  const themeBtn = document.getElementById('themeBtn');
  function setTheme(t){
    document.documentElement.setAttribute('data-theme', t);
    localStorage.setItem('theme', t);
    themeBtn.textContent = (t==='dark') ? 'Light Mode' : 'Dark Mode';
  }
  setTheme(localStorage.getItem('theme') || 'light');
  themeBtn.addEventListener('pointerdown', (e)=>{ e.preventDefault(); setTheme((localStorage.getItem('theme')||'light')==='light'?'dark':'light'); });
  themeBtn.addEventListener('keydown', (e)=> e.preventDefault());

  // ---------- UI/NET ----------
  const statusEl = document.getElementById('status');
  const pdfEl = document.getElementById('pdf');
  const uploadBtn = document.getElementById('uploadBtn');
  const downloadXlsxBtn = document.getElementById('downloadXlsxBtn');
  const downloadCsvBtn = document.getElementById('downloadCsvBtn');
  const scanEl = document.getElementById('scan');
  const activeAwbEl = document.getElementById('activeAwb');
  const searchEl = document.getElementById('search');
  const onlyAwbEl = document.getElementById('onlyAwb');
  const showAssignedEl = document.getElementById('showAssigned');

  const tbWith = document.querySelector('#tblWith tbody');
  const tbNo   = document.querySelector('#tblNo tbody');
  const skuLine = document.getElementById('skuLine');
  const countNo   = document.getElementById('countNo');

  let DATA = [];
  let ACTIVE_AWB = "";

  // Colors mapping
  const COLOR_BY_SKU = {
    AT0001: {name:'Black',   style:'background:#000'},
    AT0002: {name:'Blue',    style:'background:#2563eb'},
    AT0003: {name:'White',   style:'background:#fff; border:1px solid #d1d5db'},
    AT0004: {name:'Pink',    style:'background:#ffc0cb'},
    AT0020: {name:'Black',   style:'background:#000'},
    AT0021: {name:'Gradient black', style:'background:linear-gradient(45deg,#000,#333)'},
    AT0022: {name:'Silver',  style:'background:#c0c0c0'}
  };
  const PRIMARY_SKUS = ['AT0001','AT0002','AT0003','AT0004'];

  function focusScanner(){ if (scanEl) { scanEl.focus(); scanEl.select && scanEl.select(); } }
  focusScanner();

  function setStatus(msg){ statusEl.textContent = msg || ''; }
  function normSku(s){ return (s||'').toUpperCase().replace(/[^A-Z0-9]/g,''); }
  function isAwb(s){ return /^[A-Z0-9]{8,}$/i.test((s||'')); }
  function isBarcode(s){
    s = (s||'');
    const primary = /^\s*[A-Za-z]{2,}\d+\s*-\s*[A-Za-z]\s*\d{1,3}\s*$/;      // AT0001-A001
    const generic = /^\s*[A-Za-z]{2,}\d+\s*-\s*[A-Za-z0-9]{1,10}\s*$/;       // AT0020-ABC123
    const skuOnly = /^\s*(AT0020|AT0021|AT0022)\s*$/i;                        // bare loose SKUs
    return primary.test(s) || generic.test(s) || skuOnly.test(s);
  }

  async function safeJSON(res){
    const text = await res.text();
    try { return JSON.parse(text); }
    catch { return {ok:false, error: text || (res.status+' '+res.statusText)}; }
  }

  async function refresh(noCache){
    try{
      const url = noCache ? '/data?ts='+Date.now() : '/data';
      const res = await fetch(url, {cache:'no-store'});
      const j = await safeJSON(res);
      if(!res.ok){ throw new Error(j.error || ('HTTP '+res.status)); }
      DATA = j;
      renderTables();
      setStatus(`Loaded ${DATA.length} rows.`);
    }catch(err){
      console.error(err);
      setStatus('Load failed: ' + err.message);
    } finally {
      focusScanner();
    }
  }

  function matchesSearch(row, q){
    if(!q) return true;
    q = q.toLowerCase();
    return (
      (row.customer_name||'').toLowerCase().includes(q) ||
      (row.product_name||'').toLowerCase().includes(q) ||
      (row.sku||'').toLowerCase().includes(q) ||
      (row.awb||'').toLowerCase().includes(q) ||
      (row.contact_number||'').toLowerCase().includes(q)
    );
  }

  // --------- Units progress ----------
  function qtyOf(row){ const n = parseInt((row.quantity||'').toString().trim(),10); return Number.isFinite(n)?n:0; }
  function scannedOf(row){ const p=(row.product_id||'').trim(); return p? p.split(',').filter(Boolean).length : 0; }

  function buildGroupMaps(rows){
    const skuRows = rows.filter(r => (r.sku||'').trim() !== '');
    const totalUnits = new Map();
    const scannedUnits  = new Map();
    for(const r of skuRows){
      const c = (r.contact_number||'').trim();
      totalUnits.set(c, (totalUnits.get(c)||0) + qtyOf(r));
      scannedUnits.set(c, (scannedUnits.get(c)||0) + scannedOf(r));
    }
    return { totalUnits, scannedUnits };
  }
  function groupComplete(contact, maps){
    const c = (contact||'').trim();
    const t = maps.totalUnits.get(c)||0;
    const d = maps.scannedUnits.get(c)||0;
    return t>0 && d>=t;
  }
  function groupProgress(contact, maps){
    const c = (contact||'').trim();
    return { d: (maps.scannedUnits.get(c)||0), t: (maps.totalUnits.get(c)||0) };
  }

  function calcSkuUnitTotals(rows){
    const totals = new Map();
    for(const r of rows){
      const s = normSku(r.sku);
      if(!s) continue;
      totals.set(s, (totals.get(s)||0) + qtyOf(r));
    }
    return totals;
  }

  function renderSkuChips(totals){
    const present = Array.from(totals.keys());
    const prim = PRIMARY_SKUS.filter(s => present.includes(s));
    const extra = present.filter(s => !PRIMARY_SKUS.includes(s)).sort();
    function chip(sku){
      const val = totals.get(sku) || 0;
      const color = COLOR_BY_SKU[sku]?.style || 'background:#999';
      const title = COLOR_BY_SKU[sku]?.name || 'colour';
      return `<span class="chip" title="${title}">
                <span class="sq" style="${color}"></span>
                ${sku}: ${val}
              </span>`;
    }
    const primHtml = prim.map(chip).join('');
    const extraHtml = extra.length ? `<span class="divider">|</span>` + extra.map(chip).join('') : '';
    skuLine.innerHTML = primHtml + extraHtml;
  }

  function renderTables(){
    const q = (searchEl.value||'').trim();
    const onlyAwb = onlyAwbEl ? !!onlyAwbEl.checked : false;
    const showAssigned = showAssignedEl ? !!showAssignedEl.checked : false;

    let filtered = DATA.filter(r => {
      if(onlyAwb && ACTIVE_AWB && r.awb !== ACTIVE_AWB) return false;
      return matchesSearch(r, q);
    });

    const maps = buildGroupMaps(filtered);
    const visible = filtered.filter(r => !groupComplete(r.contact_number, maps));

    const withSku = visible.filter(r => (r.sku||'').trim() !== '');
    const noSku   = visible.filter(r => (r.sku||'').trim() === '');

    // SKU totals line
    renderSkuChips(calcSkuUnitTotals(withSku));

    // LEFT: with SKU rows
    tbWith.innerHTML = '';
    for(const row of withSku){
      const tr = document.createElement('tr');
      if(ACTIVE_AWB && row.awb===ACTIVE_AWB) tr.classList.add('active');
      const scanned = scannedOf(row), qty = qtyOf(row);
      const rowDone = qty>0 && scanned>=qty;
      const chip = rowDone ? `<span class="chip ok">✅ ${qty}/${qty}</span>` : `<span class="chip">${scanned}/${qty}</span>`;
      const gp = groupProgress(row.contact_number, maps);
      const groupChip = gp.t>0 ? `<span class="chip">${gp.d}/${gp.t} total</span>` : '';
      if(!showAssigned && rowDone && groupComplete(row.contact_number, maps)){ continue; }
      tr.innerHTML = `
        <td>${row.order_date||''}</td>
        <td>${row.customer_name||''}</td>
        <td>${row.contact_number||''}</td>
        <td>${row.product_name||''}</td>
        <td>${row.sku||''}</td>
        <td>${row.quantity||''}</td>
        <td>${row.awb||''}</td>
        <td>${row.product_id||''}</td>
        <td>${chip} ${groupChip}</td>`;
      tbWith.appendChild(tr);
    }

    // RIGHT: no SKU — add confirm button
    tbNo.innerHTML = '';
    for(const row of noSku){
      // hide confirmed extras
      if ((row.product_id||'').trim() !== '') continue;
      const tr = document.createElement('tr');
      if(ACTIVE_AWB && row.awb===ACTIVE_AWB) tr.classList.add('active');
      tr.innerHTML = `
        <td>${row.order_date||''}</td>
        <td>${row.customer_name||''}</td>
        <td>${row.contact_number||''}</td>
        <td>${row.product_name||''}</td>
        <td>${row.quantity||''}</td>
        <td>${row.awb||''}</td>
        <td><input class="pid-input" type="text" placeholder="optional ID" value="${row.product_id||''}"></td>
        <td><button class="btn-icon" data-rowid="${row.row_id}">✅</button></td>`;
      tbNo.appendChild(tr);
    }
    countNo.textContent = tbNo.querySelectorAll('tr').length;

    // wire confirm buttons
    tbNo.querySelectorAll('button.btn-icon').forEach(btn=>{
  btn.addEventListener('click', async ()=>{
    const id = btn.getAttribute('data-rowid');
    const tr = btn.closest('tr');
    const pidInput = tr ? tr.querySelector('input.pid-input') : null;
    const product_id = pidInput ? (pidInput.value || '').trim().toUpperCase() : '';

    try{
      const res = await fetch('/confirm_extra', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ row_id: id, product_id })
      });
      const j = await safeJSON(res);
      if(!res.ok || !j.ok){ throw new Error(j.error || j.message || ('HTTP '+res.status)); }
      setStatus('Confirmed extra ✓');
      await refresh(true);
    }catch(err){
      alert('Confirm failed: ' + err.message);
    }
  });
});
  }

  // Upload
  uploadBtn.addEventListener('click', async ()=>{
    const f = pdfEl.files && pdfEl.files[0];
    if(!f){ alert('Choose a PDF'); return; }
    const fd = new FormData(); fd.append('file', f);
    setStatus('Parsing…');
    try{
      const res = await fetch('/upload', {method:'POST', body:fd});
      const j = await safeJSON(res);
      if(!res.ok || !j.ok){ throw new Error(j.error || ('HTTP '+res.status)); }
      setStatus(`Parsed: ${j.parsed}, Added: ${j.added}.`);
      await refresh(true);
    }catch(err){
      console.error(err);
      setStatus('Upload failed: ' + err.message);
    }
  });

  // Scanner (swallow Enter; keep focus)
  scanEl.addEventListener('keydown', async (e)=>{
  if(e.key !== 'Enter') return;
  e.preventDefault(); e.stopPropagation();

  const code = e.target.value.trim(); e.target.value = '';
  if(!code) { return; }

  // BARCODE
  if(isBarcode(code)){
    try{
      const res = await fetch('/assign_barcode', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ barcode: code, awb: (window.ACTIVE_AWB || null) })
      });
      const j = await safeJSON(res);
      if(!res.ok || !j.ok){ throw new Error(j.error || j.message || ('HTTP '+res.status)); }

      setStatus(j.message || 'Assigned');

      // >>> NEW: auto-print the page when the whole label (incl. loose items) is complete
      // After: setStatus(j.message || 'Assigned');

if (j.group_complete && j.print_info && j.print_info.source_file && j.print_info.page_index) {
  const printer = getPrinter();
  if (printer) {
    // SILENT server-side print to the specific printer
    try{
      const pr = await fetch('/label_print_silent', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({
          source: j.print_info.source_file,
          page:   parseInt(j.print_info.page_index, 10),
          printer
        })
      });
      const pj = await safeJSON(pr);
      if (!pr.ok || !pj.ok) throw new Error(pj.error || pj.message || ('HTTP '+pr.status));
      setStatus(`Printed → ${printer}`);
    }catch(err){
      console.error(err);
      // Fallback: open the print page (will show dialog)
      const url = `/label_print?source=${encodeURIComponent(j.print_info.source_file)}&page=${encodeURIComponent(j.print_info.page_index)}`;
      window.open(url, '_blank');
      setStatus('Silent print failed; opened print dialog instead');
    }
  } else {
    // No printer configured: open normal print tab (dialog)
    const url = `/label_print?source=${encodeURIComponent(j.print_info.source_file)}&page=${encodeURIComponent(j.print_info.page_index)}`;
    window.open(url, '_blank');
  }
}

      // <<< NEW END

      await refresh(true);
    }catch(err){
      console.error(err);
      setStatus('Barcode assign failed: ' + err.message);
      alert('Barcode assign failed: ' + err.message);
    }
    return;
  }

  // AWB
  if(isAwb(code)){
    window.ACTIVE_AWB = code.toUpperCase();
    activeAwbEl.textContent = window.ACTIVE_AWB || '—';
    await refresh(true);
    return;
  }

  setStatus('Not an AWB or barcode');
});


  // Filters
  ;[onlyAwbEl, showAssignedEl].forEach(el => { if(el){ el.addEventListener('change', renderTables); }});
  searchEl.addEventListener('input', renderTables);

  // Init
  refresh(true);
})();
</script>
</body>
</html>
